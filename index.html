<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>Systemsim</title>
    <style>
      *, *::before, *::after {
        box-sizing: border-box;
      }
      * {
        margin: 0;
      }
      html, body, .layer {
        height: 100%;
        width: 100%;
      }
      .layer {
        position: absolute;
      }
      /* layers */
      #terminal {
        background-color: black;
        color: white;
        padding: 1em;
        white-space: pre-wrap;
      }
      #UI {
        align-items: center;
        display: flex;
        justify-content: center;
      }
      #UI button {
        background-color: black;
        border: 3px lightgray double;
        color: lightgray;
        font-family: 'Courier New', monospace;
        font-size: 1.5em;
        text-shadow: 0 0 2px white;
        padding: 0.5em;
        text-align: center;
        text-decoration: none;
      }
      #UI button:hover {
        background-color: lightgray;
        color: black;
        text-shadow: 0 0 2px black;
      }
      /* layer overrides */
      .nocursor {
        cursor: none;
      }
      .monospace {
        font-family: 'Courier New', monospace;
      }
      .terminal12px {
        font-size: 12px;
      }
    </style>
    <script>
      async function sleep(ms) {
        return await new Promise(resolve => setTimeout(resolve, ms));
      }

      class Game {
        terminalBuffer = [];
        prompt = '';
        input = '';
        state = 'init';
        terminalState = 'exec';

        constructor() {}

        async init() {
          // Game init sequence
          const terminalElem = document.getElementById('terminal');
          terminalElem.innerHTML = '';
          await sleep(100);
          terminalElem.innerHTML = 'Entering fullscreen mode...<br /><br />';
          await sleep(400);
          terminalElem.classList.add('monospace');
          await sleep(1000);
          terminalElem.classList.add('terminal12px');
          await sleep(1000);
          terminalElem.classList.add('nocursor');
          await sleep(500);
          terminalElem.innerHTML += 'No player data found. Starting new game.';
          await sleep(1500);
          terminalElem.innerHTML = '';
          await sleep(1500);

          // Bind events
          document.addEventListener('keydown', async (e) => {
            if (this.terminalState !== 'input') return;

            if (/^[\w !@#$%^&*()\-+{}|~=`<>,.?/\\;:"']$/.test(e.key)) {
              this.input = this.input + e.key;
              await this.render();
            } else {
              switch (e.key) {
                case 'Enter':
                  if (this.input.length <= 0) return;
                  this.terminalBuffer.push(this.prompt + this.input + '<br />');
                  this.terminalState = 'exec';
                  await this.refresh();
                  break;
                case 'Backspace':
                  this.input = this.input.slice(0, -1);
                  await this.render();
                  break;
                default:
                  console.warn(`Unhandled key: ${e.key}`);
                  break;
              }
            }
          });

          // Main game loop
          await this.refresh();
        }

        async refresh() {
          if (this.terminalState === 'exec') {
            switch (this.state) {
              case 'init':
                switch (this.input) {
                  case '':
                    this.print('You are sitting at your desk, in front of your home computer. It is currently shut down.<br />');
                    this.waitInput('Possible actions: [boot inspect stand]<br /><br />Action: ');
                    break;
                  case 'boot':
                    return this.switchState('boot', { cls: true });
                  case 'inspect':
                    return this.switchState('inspect-desk');
                  case 'stand':
                    return this.switchState('inspect-room');
                  default:
                    this.print('Invalid action. ');
                    this.waitInput();
                    break;
                }
                break;
              case 'inspect-desk':
                switch (game.input) {
                  case '':
                    this.print('You look at the desk.<br />');
                    await sleep(600);
                    this.print('On top of it, from left to right, there is a family picture, a small pile of memory sticks, a pile of electronics, and a large notepad with a pen.<br />' +
                      'It has three drawers in one side, and the computer tower on the other one. Next to it a few paper bags are leaning on its side.<br />');
                    await sleep(600);
                    this.waitInput('Possible actions: [picture memorysticks electronics notepad drawer1/2/3 tower bags boot stand]<br /><br />Action: ');
                    break;
                  case 'boot':
                    return this.switchState('boot', { cls: true });
                  case 'stand':
                    return this.switchState('inspect-room');
                  default:
                    this.print('Invalid action. ');
                    this.waitInput();
                    break;
                }
                break;
              case 'boot':
                switch (game.input) {
                  case '':
                    await sleep(300);
                    this.print('&gt; Loading kernel... ');
                    await sleep(700);
                    this.print('OK<br />' +
                      '&gt; Loading boot image... ');
                    await sleep(1000);
                    this.print('OK<br />' +
                      '&gt; System initialized.<br />For a list of commands, type \'help\'.<br /><br />');
                    await sleep(500);
                    this.waitInput('/root # ');
                    break;
                  case 'help':
                    this.print(
                      'help [command]    - Display help for a command<br />' +
                      'ls                - List files in current directory<br />' +
                      'cd [path]         - Change directory. Use \'..\' to go up a directory<br />' +
                      'poweroff          - Shut down the computer<br />' +
                      '<br />' +
                      'All binaries located in /bin can also be executed as commands.<br /><br />');
                    this.waitInput();
                    break;
                  case 'poweroff':
                    await sleep(600);
                    this.cls();
                    await sleep(1000);
                    return this.switchState('init');
                  default:
                    this.print(`Unknown command: ${game.input}<br />For a list of commands, type 'help'.<br /><br />`);
                    this.waitInput();
                    break;
                }
                break;
            }
          }
        }

        cls() {
          document.getElementById('terminal').innerHTML = '';
          this.terminalBuffer = [];
        }

        render() {
          if (this.terminalState === 'input') {
            document.getElementById('terminal').innerHTML = game.terminalBuffer.join('') + game.prompt + game.input;
          } else {
            document.getElementById('terminal').innerHTML = game.terminalBuffer.join('');
          }
        }

        print(text) {
          this.terminalBuffer.push(text);
          this.render();
        }

        async switchState(state, options = { cls: false }) {
          this.state = state;
          this.input = '';

          if (options.cls) {
            this.cls();
          }

          return this.refresh();
        }

        waitInput(prompt) {
          this.input = '';
          if (prompt) {
            this.prompt = prompt;
          }

          this.terminalState = 'input';

          this.render();
        }
      }

      const game = new Game();

      document.addEventListener('DOMContentLoaded', async () => {
        document.getElementById('fullscreen-btn').addEventListener('click', async () => {
          const docElm = document.documentElement;
          if (docElm.requestFullscreen) {
            docElm.requestFullscreen();
          } else if (docElm.msRequestFullscreen) {
            docElm.msRequestFullscreen();
          } else if (docElm.mozRequestFullScreen) {
            docElm.mozRequestFullScreen();
          } else if (docElm.webkitRequestFullScreen) {
            docElm.webkitRequestFullScreen();
          }
          document.getElementById('fullscreen-btn').remove();

          await game.init();
        });
      });
    </script>
  </head>
  <body>
    <div id="terminal" class="layer">
    </div>
    <div id="UI" class="layer" style="z-index: 1;">
      <button id="fullscreen-btn">Launch Game</button>
    </div>
  </body>
</html>
