<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>Systemsim</title>
    <style>
      *, *::before, *::after {
        box-sizing: border-box;
      }
      * {
        margin: 0;
        font-family: 'Courier New', monospace;
      }
      html, body {
        background-color: black;
        color: white;
        height: 100%;
        width: 100%;
      }
      #terminal {
        font-size: 12px;
        padding: 1em;
        white-space: pre-wrap;
      }
      .nocursor {
        cursor: none;
      }
    </style>
    <script>
      async function sleep(ms) {
        return await new Promise(resolve => setTimeout(resolve, ms));
      }

      class Game {
        terminalBuffer = [];
        prompt = '';
        input = '';
        state = 'init';
        terminalState = 'exec';

        constructor() {}

        async init() {
          document.addEventListener('keydown', async (e) => {
            if (this.terminalState !== 'input') return;

            if (/^[\w !@#$%^&*()\-+{}|~=`<>,.?/\\;:"']$/.test(e.key)) {
              this.input = this.input + e.key;
            } else {
              switch (e.key) {
                case 'Enter':
                  this.terminalBuffer.push(this.prompt + this.input + '<br />');
                  this.terminalState = 'exec';
                  break;
                case 'Backspace':
                  this.input = this.input.slice(0, -1);
                  break;
                default:
                  break;
              }
            }

            await this.refresh();
          });

          await this.refresh();
        }

        async refresh() {
          if (game.terminalState === 'exec') {
            switch (game.state) {
              case 'init':
                switch (game.input) {
                  case '':
                    game.prompt = 'You are sitting at your desk, in front of your home computer. It is currently shut down.<br />Possible actions: [boot inspect stand]<br /><br />Action: ';
                    game.input = '';
                    game.terminalState = 'input';
                    break;
                  case 'boot':
                    game.state = 'boot';
                    document.getElementById('terminal').innerHTML = '';
                    game.terminalBuffer = [];
                    game.input = '';
                    return this.refresh();
                  case 'inspect':
                    game.state = 'inspect';
                    game.input = '';
                    return this.refresh();
                  case 'stand':
                    game.state = 'stand';
                    game.input = '';
                    return this.refresh();
                  default:
                    game.prompt = 'Invalid action. Possible actions: [boot inspect stand]<br /><br />Action: ';
                    game.input = '';
                    game.terminalState = 'input';
                    break;
                }
                break;
              case 'boot':

                switch (game.input) {
                  case '':
                    await sleep(300);
                    game.prompt = '&gt; Loading kernel... OK<br />' +
                            '&gt; Loading boot image... OK<br />' +
                            '&gt; System initialized.<br />For a list of commands, type \'help\'.<br /><br />' +
                            '/root # ';
                    game.input = '';
                    game.terminalState = 'input';
                    break;
                  case 'help':
                    game.prompt =
                            'help [command]    - Display help for a command<br />' +
                            'ls                - List files in current directory<br />' +
                            'cd [path]         - Change directory. Use \'..\' to go up a directory<br />' +
                            'poweroff          - Shut down the computer<br />' +
                            '<br />' +
                            'All binaries located in /bin can also be executed as commands.<br /><br />' +
                            '/root # ';
                    game.input = '';
                    game.terminalState = 'input';
                    break;
                  case 'poweroff':
                    game.state = 'init';
                    game.terminalBuffer = [];
                    game.input = '';
                    return this.refresh();
                  default:
                    game.prompt = 'Unknown command: ' + game.input + '<br />For a list of commands, type \'help\'.<br /><br />/root # ';
                    game.input = '';
                    game.terminalState = 'input';
                    break;
                }
                break;
            }
          }

          document.getElementById('terminal').innerHTML = game.terminalBuffer.join('') + game.prompt + game.input;
        }
      }

      const game = new Game();

      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('fullscreen').addEventListener('click', async () => {
          const docElm = document.documentElement;
          if (docElm.requestFullscreen) {
            docElm.requestFullscreen();
          } else if (docElm.msRequestFullscreen) {
            docElm.msRequestFullscreen();
          } else if (docElm.mozRequestFullScreen) {
            docElm.mozRequestFullScreen();
          } else if (docElm.webkitRequestFullScreen) {
            docElm.webkitRequestFullScreen();
          }

          document.getElementById('terminal').innerHTML = '';
          await sleep(100);
          document.getElementById('terminal').innerHTML = 'Entering fullscreen mode...<br /><br />';
          await sleep(3000);
          document.getElementById('terminal').classList.add('nocursor');
          document.getElementById('terminal').innerHTML += 'No player data found. Starting new game.';
          await sleep(1500);
          document.getElementById('terminal').innerHTML = '';
          await sleep(1500);
          await game.init();
        });
      });
    </script>
  </head>
  <body id="terminal">
    <button id="fullscreen">Launch Game</button>
  </body>
</html>
