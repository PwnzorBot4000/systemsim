<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>Systemsim</title>
    <style>
      *, *::before, *::after {
        box-sizing: border-box;
      }
      * {
        margin: 0;
        font-family: 'Courier New', monospace;
      }
      body {
        color: white;
        background-color: black;
      }
      #terminal {
        font-size: 12px;
        white-space: pre-wrap;
      }
    </style>
    <script>
      class Game {
        terminalBuffer = [];
        prompt = '';
        input = '';
        state = 'init';
        terminalState = 'exec';

        constructor() {}

        openFullscreen() {
          // https://www.w3schools.com/howto/howto_js_fullscreen.asp
          console.debug("Opening fullscreen");
          if (document.requestFullscreen) {
            document.requestFullscreen();
          } else if (document.webkitRequestFullscreen) { /* Safari */
            document.webkitRequestFullscreen();
          } else if (document.msRequestFullscreen) { /* IE11 */
            document.msRequestFullscreen();
          }
        }

        refresh() {
          if (game.terminalState === 'exec') {
            switch (game.state) {
              case 'init':
                switch (game.input) {
                  case '':
                    game.prompt = 'You are sitting at your desk, in front of your home computer. It is currently shut down.<br />Possible actions: [boot inspect stand]<br /><br />Action: ';
                    game.input = '';
                    game.terminalState = 'input';
                    break;
                  case 'boot':
                    game.state = 'boot';
                    game.terminalBuffer = [];
                    game.input = '';
                    return this.refresh();
                  case 'inspect':
                    game.state = 'inspect';
                    game.input = '';
                    return this.refresh();
                  case 'stand':
                    game.state = 'stand';
                    game.input = '';
                    return this.refresh();
                  default:
                    game.prompt = 'Invalid action. Possible actions: [boot inspect stand]<br /><br />Action: ';
                    game.input = '';
                    game.terminalState = 'input';
                    break;
                }
                break;
              case 'boot':

                switch (game.input) {
                  case '':
                    game.prompt = '&gt; Loading kernel... OK<br />' +
                            '&gt; Loading boot image... OK<br />' +
                            '&gt; System initialized.<br />For a list of commands, type \'help\'.<br /><br />' +
                            '/root # ';
                    game.input = '';
                    game.terminalState = 'input';
                    break;
                  case 'help':
                    game.prompt =
                            'help [command]    - Display help for a command<br />' +
                            'ls                - List files in current directory<br />' +
                            'cd [path]         - Change directory. Use \'..\' to go up a directory<br />' +
                            '<br />' +
                            'All binaries located in /bin can also be executed as commands.<br /><br />' +
                            '/root # ';
                    game.input = '';
                    game.terminalState = 'input';
                    break;
                  default:
                    game.prompt = 'Unknown command: ' + game.input + '<br />For a list of commands, type \'help\'.<br /><br />/root # ';
                    game.input = '';
                    game.terminalState = 'input';
                    break;
                }
                break;
            }
          }

          document.getElementById('terminal').innerHTML = game.terminalBuffer.join('') + game.prompt + game.input;
        }
      }

      const game = new Game();

      document.addEventListener("DOMContentLoaded", () => {
        game.openFullscreen();
        game.refresh();
      });

      document.addEventListener("keydown", (e) => {
        if (/^[\w !@#$%^&*()\-+{}|~=`<>,.?/\\;:"']$/.test(e.key)) {
          game.input = game.input + e.key;
        } else {
          switch (e.key) {
            case 'Enter':
              game.terminalBuffer.push(game.prompt + game.input + '<br />');
              game.terminalState = 'exec';
              break;
            case 'Backspace':
              game.input = game.input.slice(0, -1);
              break;
            default:
              break;
          }
        }
        game.refresh();
      });
    </script>
  </head>
  <body id="terminal">
  </body>
</html>
