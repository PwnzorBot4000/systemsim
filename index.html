<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>Systemsim</title>
    <style>
      *, *::before, *::after {
        box-sizing: border-box;
      }
      * {
        margin: 0;
      }
      html, body, .layer {
        height: 100%;
        width: 100%;
      }
      .layer {
        position: absolute;
      }
      /* layers */
      #terminal {
        background-color: black;
        color: white;
        padding: 1em;
        white-space: pre-wrap;
      }
      #UI {
        align-items: center;
        display: flex;
        justify-content: center;
      }
      #UI button {
        background-color: black;
        border: 3px lightgray double;
        color: lightgray;
        font-family: 'Courier New', monospace;
        font-size: 1.5em;
        text-shadow: 0 0 2px white;
        padding: 0.5em;
        text-align: center;
        text-decoration: none;
        transition: 0.2s;
      }
      #UI button:hover {
        background-color: lightgray;
        color: black;
        text-shadow: 0 0 2px black;
      }
      /* layer overrides */
      .nocursor {
        cursor: none;
      }
      .monospace {
        font-family: 'Courier New', monospace;
      }
      .terminal12px {
        font-size: 12px;
      }
    </style>
    <script>
      async function sleep(ms) {
        return await new Promise(resolve => setTimeout(resolve, ms));
      }

      class Game {
        terminalBuffer = [];
        prompt = '';
        input = '';
        state = 'init';
        terminalState = 'exec';

        constructor() {}

        async init() {
          // Game init sequence
          const terminalElem = document.getElementById('terminal');
          terminalElem.innerHTML = '';
          await sleep(100);
          terminalElem.innerHTML = 'Entering fullscreen mode...<br /><br />';
          await sleep(400);
          terminalElem.classList.add('monospace');
          await sleep(1000);
          terminalElem.classList.add('terminal12px');
          await sleep(1000);
          terminalElem.classList.add('nocursor');
          await sleep(500);
          terminalElem.innerHTML += 'No player data found. Starting new game.';
          await sleep(1500);
          terminalElem.innerHTML = '';
          await sleep(1500);

          // Bind events
          document.addEventListener('keydown', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (this.terminalState !== 'input') return;

            if (/^[\w !@#$%^&*()\-+{}|~=`<>,.?/\\;:"']$/.test(e.key)) {
              this.input = this.input + e.key;
              await this.render();
            } else {
              switch (e.key) {
                case 'Enter':
                  if (this.input.length <= 0) return;
                  this.terminalBuffer.push(this.prompt + this.input + '<br />');
                  this.terminalState = 'exec';
                  await this.refresh();
                  break;
                case 'Backspace':
                  this.input = this.input.slice(0, -1);
                  await this.render();
                  break;
                default:
                  console.warn(`Unhandled key: ${e.key}`);
                  break;
              }
            }
          });

          document.getElementById('terminal').addEventListener('click', (e) => {
            if (e.target.id === 'terminal' && this.terminalState === 'input') {
              document.getElementById('input-capture').focus();
            }
          });

          // Main game loop
          await this.refresh();
        }

        async refresh() {
          if (this.terminalState === 'exec') {
            switch (this.state) {
              case 'init':
                switch (this.input) {
                  case '':
                    this.print('You are sitting at your desk, in front of your home computer. It is currently shut down.<br />');
                    this.waitInput('Possible actions: [boot inspect stand]<br /><br />Action: ');
                    break;
                  case 'boot':
                    return this.switchState('boot', { cls: true });
                  case 'inspect':
                    return this.switchState('inspect-desk');
                  case 'stand':
                    return this.switchState('inspect-room');
                  default:
                    this.print('Invalid action. ');
                    this.waitInput();
                    break;
                }
                break;
              case 'inspect-desk':
                switch (game.input) {
                  case '':
                    this.print('You look at the desk.<br />');
                    await sleep(600);
                    this.print('On top of it, from left to right, there is a family picture, a small pile of memory sticks, a pile of electronics, and a large notepad with a pen.<br />' +
                      'It has three drawers in one side, and the computer tower on the other one. Next to it a few paper bags are leaning on its side.<br />');
                    await sleep(600);
                    this.waitInput('Possible actions: [picture memorysticks electronics notepad drawer1/2/3 tower bags boot stand]<br /><br />Action: ');
                    break;
                  case 'picture':
                    this.print('You look at the picture.<br />');
                    await sleep(600);
                    this.print(
                      'It is a picture of your parents, with you in the middle. They are holding you from the hands, one hand each.<br />' +
                      'The date on the photo is 2006 May 16.<br />');
                    await sleep(600);
                    this.waitInput();
                    break;
                  case 'memorysticks':
                    this.print(
                      'There are 3 memory sticks in the pile:<br />' +
                      'Stick 1 (16GB, USB-A 3.0) is a live USB with a Linux distribution on it. It was used to originally set up the computer.<br />' +
                      'Sticks 2 (8GB, USB-A 3.0) and 3 (32GB, USB-C 3.1) are empty.<br />');
                    this.waitInput();
                    break;
                  case 'electronics':
                    this.print(
                      'The pile of electronics contains:<br />' +
                      '- 2 RFID tags, opened with their contacts exposed.<br />' +
                      '- A soldering iron, solder and flux.<br />' +
                      '- 1.5 meter of USB 3.0 cable.<br />' +
                      '- 2 meters of low voltage cable, solid core.<br />' +
                      '- A sachel of about 10 MOSFETs.<br />');
                    this.waitInput();
                    break;
                  case 'notepad':
                    this.print(
                      'A large notepad with a pen is on the desk.<br />' +
                      'It is currently empty, with a few doodles on it.<br />');
                    this.waitInput();
                    break;
                  case 'drawer1':
                    this.print(
                      'You open the first drawer. It contains:<br />' +
                      '- A book about the history of the computer industry.<br />' +
                      '- A USB-A to USB-C 3.0 cable.<br />' +
                      '- A TV remote control for your monitor, unused.<br />' +
                      '- 3 AAA batteries.<br />' +
                      '- A box of paper clips.<br />');
                    this.waitInput();
                    break;
                  case 'drawer2':
                    this.print(
                      'You open the second drawer. It contains:<br />' +
                      '- 2 AA batteries, expired.<br />' +
                      '- A spoon.<br />' +
                      '- A stack of sticky notes.<br />' +
                      '- A syringe of thermal paste.<br />' +
                      '- An old low-performance CPU cooler.<br />');
                    this.waitInput();
                    break;
                  case 'drawer3':
                    this.print(
                      'You open the third drawer. It contains:<br />' +
                      '- A pair of over-ear headphones. The plastic coating of the muffs is chipped.<br />' +
                      '- A pair of trousers.<br />' +
                      '- A fork with some steel wire wrapped around it.<br />' +
                      '- A bottle of cologne.<br />' +
                      '- A packet of tissues.<br />');
                    this.waitInput();
                    break;
                  case 'tower':
                    this.print(
                      'You open the computer tower. It is equipped with:<br />' +
                      '- 512 MB of DDR3 RAM @800 MHz.<br />' +
                      '- A dual-core 4th generation CPU @2.7 GHz w/ 2MB cache, overclocked to 3.3 GHz.<br />' +
                      '- A 4-5th gen chipset motherboard with support for up to 16GB of RAM @1.6 GHz.<br />' +
                      '- A 1TB HDD with a SATA interface.<br />' +
                      '- No graphics card.<br />' +
                      '- A 300 W power supply.<br />');
                    this.waitInput();
                    break;
                  case 'bags':
                    this.print(
                      'You search the bags. There is:<br />' +
                      '- A small bag containing the empty packaging of a cologne bottle.<br />' +
                      '- A large bag containing the empty packaging of a CPU cooler.<br />');
                    this.waitInput();
                    break;
                  case 'boot':
                    return this.switchState('boot', { cls: true });
                  case 'stand':
                    this.print('You stand up.<br />');
                    await sleep(600);
                    return this.switchState('inspect-room');
                  default:
                    this.print('Invalid action. ');
                    this.waitInput();
                    break;
                }
                break;
              case 'boot':
                switch (game.input) {
                  case '':
                    await sleep(300);
                    this.print('&gt; Loading kernel... ');
                    await sleep(700);
                    this.print('OK<br />' +
                      '&gt; Loading boot image... ');
                    await sleep(1000);
                    this.print('OK<br />' +
                      '&gt; System initialized.<br />For a list of commands, type \'help\'.<br /><br />');
                    await sleep(500);
                    this.waitInput('/root # ');
                    break;
                  case 'help':
                    this.print(
                      'help [command]    - Display help for a command<br />' +
                      'ls                - List files in current directory<br />' +
                      'cd [path]         - Change directory. Use \'..\' to go up a directory<br />' +
                      'poweroff          - Shut down the computer<br />' +
                      '<br />' +
                      'All binaries located in /bin can also be executed as commands.<br /><br />');
                    this.waitInput();
                    break;
                  case 'poweroff':
                    await sleep(600);
                    this.cls();
                    await sleep(1000);
                    return this.switchState('init');
                  default:
                    this.print(`Unknown command: ${game.input}<br />For a list of commands, type 'help'.<br /><br />`);
                    this.waitInput();
                    break;
                }
                break;
              case 'inspect-room':
                switch (game.input) {
                  case '':
                    this.waitInput('Possible actions: [bookcase desk outside]<br /><br />Action: ');
                    break;
                  case 'bookcase':
                    this.print('You look at the bookcase.<br />' +
                      'It is a small bookcase with a few books on it, and a couple of cabinets at the bottom.<br />' +
                      'The first cabinet contains monitor cables and a pair of shoes.<br />' +
                      'The second cabinet contains clothes.<br />' +
                      'The bookcase itself contains books about programming languages, and some novels.<br />');
                    await sleep(600);
                    this.waitInput();
                    break;
                  case 'desk':
                    return this.switchState('init');
                  case 'outside':
                    this.print('You exit the room.<br />');
                    await sleep(1000);
                    return this.switchState('outside', { cls: true });
                  default:
                    this.print('Invalid action. ');
                    this.waitInput();
                    break;
                }
                break;
              case 'outside':
                switch (game.input) {
                  case '':
                    this.waitInput('Go where? [home convenience-store bills-computer-shop coffee-shop home-depot]<br /><br />Action: ');
                    break;
                  case 'home':
                    this.print('You return to your home.<br />');
                    await sleep(1000);
                    return this.switchState('inspect-room', { cls: true });
                  case 'convenience-store':
                    return this.switchState('convenience-store');
                  case 'bills-computer-shop':
                    this.print('You don\'t need anything from the computer shop right now.<br />');
                    this.waitInput();
                    break;
                    // return this.switchState('bills-computer-shop');
                  case 'coffee-shop':
                    this.print('You don\'t need anything from the coffee shop right now.<br />');
                    this.waitInput();
                    break;
                    // return this.switchState('coffee-shop');
                  case 'home-depot':
                    this.print('You don\'t need anything from the home depot right now.<br />');
                    this.waitInput();
                    break;
                    // return this.switchState('home-depot');
                  default:
                    this.print('Invalid action. ');
                    this.waitInput();
                    break;
                }
                break;
              case 'convenience-store':
                switch (game.input) {
                  case '':
                    this.waitInput('Possible actions: [newspapers outside]<br /><br />Action: ');
                    break;
                  case 'newspapers':
                    this.print('You look at the digital newspaper subscription ads. The headlines are:<br />' +
                      '- The ePhone to replace all ePhones: Meet the new eGalaxy Cluster<br />' +
                      '- Ablue vault heist - Thousands of private keys stolen - Macrosoft urges users to generate new keys<br />' +
                      '- EnvyTech to invest up to $100 million in cryptocurrency - stock markets worried<br />' +
                      '- Metaspace AR: Get your own digital flower with only $6/mo!<br />');
                    await sleep(600);
                    this.waitInput();
                    break;
                  case 'outside':
                    this.print('You exit the convenience store.<br />');
                    return this.switchState('outside');
                  default:
                    this.print('Invalid action. ');
                    this.waitInput();
                    break;
                }
                break;
            }
          }
        }

        cls() {
          document.getElementById('terminal').innerHTML = '';
          this.terminalBuffer = [];
        }

        render() {
          if (this.terminalState === 'input') {
            document.getElementById('terminal').innerHTML = game.terminalBuffer.join('') + game.prompt + game.input;
          } else {
            document.getElementById('terminal').innerHTML = game.terminalBuffer.join('');
          }
        }

        print(text) {
          this.terminalBuffer.push(text);
          this.render();
        }

        async switchState(state, options = { cls: false }) {
          this.state = state;
          this.input = '';

          if (options.cls) {
            this.cls();
          }

          return this.refresh();
        }

        waitInput(prompt) {
          this.input = '';
          if (prompt) {
            this.prompt = prompt;
          }

          this.terminalState = 'input';
          document.getElementById('input-capture').focus();

          this.render();
        }
      }

      const game = new Game();

      document.addEventListener('DOMContentLoaded', async () => {
        document.getElementById('fullscreen-btn').addEventListener('click', async () => {
          const docElm = document.documentElement;
          if (docElm.requestFullscreen) {
            docElm.requestFullscreen();
          } else if (docElm.msRequestFullscreen) {
            docElm.msRequestFullscreen();
          } else if (docElm.mozRequestFullScreen) {
            docElm.mozRequestFullScreen();
          } else if (docElm.webkitRequestFullScreen) {
            docElm.webkitRequestFullScreen();
          }
          document.getElementById('fullscreen-btn').remove();
          document.getElementById('UI').style.display = 'none';

          await game.init();
        });
      });
    </script>
  </head>
  <body>
    <div id="hidden-controls" class="layer" style="z-index: -10; visibility: hidden">
      <label for="input-capture">User input capture field:</label>
      <input id="input-capture" name="input-capture" type="text" autocomplete="off" spellcheck="false" />
    </div>
    <div id="terminal" class="layer">
    </div>
    <div id="UI" class="layer" style="z-index: 1;">
      <button id="fullscreen-btn">Launch Game</button>
    </div>
  </body>
</html>
