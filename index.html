<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>Systemsim</title>
    <style>
      *, *::before, *::after {
        box-sizing: border-box;
      }
      * {
        margin: 0;
      }
      html, body {
        background-color: black;
        color: white;
        height: 100%;
        width: 100%;
      }
      #terminal {
        padding: 1em;
        white-space: pre-wrap;
      }
      .nocursor {
        cursor: none;
      }
      .monospace {
        font-family: 'Courier New', monospace;
      }
      .terminal12px {
        font-size: 12px;
      }
    </style>
    <script>
      async function sleep(ms) {
        return await new Promise(resolve => setTimeout(resolve, ms));
      }

      class Game {
        terminalBuffer = [];
        prompt = '';
        input = '';
        state = 'init';
        terminalState = 'exec';

        constructor() {}

        async init() {
          document.addEventListener('keydown', async (e) => {
            if (this.terminalState !== 'input') return;

            if (/^[\w !@#$%^&*()\-+{}|~=`<>,.?/\\;:"']$/.test(e.key)) {
              this.input = this.input + e.key;
              await this.render();
            } else {
              switch (e.key) {
                case 'Enter':
                  if (this.input.length <= 0) return;
                  this.terminalBuffer.push(this.prompt + this.input + '<br />');
                  this.terminalState = 'exec';
                  await this.refresh();
                  break;
                case 'Backspace':
                  this.input = this.input.slice(0, -1);
                  await this.render();
                  break;
                default:
                  console.warn(`Unhandled key: ${e.key}`);
                  break;
              }
            }
          });

          await this.refresh();
        }

        async refresh() {
          if (this.terminalState === 'exec') {
            switch (this.state) {
              case 'init':
                switch (this.input) {
                  case '':
                    this.print('You are sitting at your desk, in front of your home computer. It is currently shut down.<br />');
                    this.waitInput('Possible actions: [boot inspect stand]<br /><br />Action: ');
                    break;
                  case 'boot':
                    return this.switchState('boot', { cls: true });
                  case 'inspect':
                    return this.switchState('inspect-desk');
                  case 'stand':
                    return this.switchState('inspect-room');
                  default:
                    this.print('Invalid action. ');
                    this.waitInput();
                    break;
                }
                break;
              case 'inspect-desk':
                switch (game.input) {
                  case '':
                    this.print('You look at the desk.<br />' +
                      'On top of it, from left to right, there is a family picture, a small pile of memory sticks, a pile of electronics, and a large notepad with a pen.<br />' +
                      'It has three drawers in one side, and the computer tower on the other one. Next to it a few paper bags are leaning on its side.<br />');
                    this.waitInput('Possible actions: [picture memorysticks electronics notepad drawer1/2/3 tower bags boot stand]<br /><br />Action: ');
                    break;
                  case 'boot':
                    return this.switchState('boot', { cls: true });
                  case 'stand':
                    return this.switchState('inspect-room');
                  default:
                    this.print('Invalid action. ');
                    this.waitInput();
                    break;
                }
                break;
              case 'boot':
                switch (game.input) {
                  case '':
                    await sleep(300);
                    this.print(
                      '&gt; Loading kernel... OK<br />' +
                      '&gt; Loading boot image... OK<br />' +
                      '&gt; System initialized.<br />For a list of commands, type \'help\'.<br /><br />');
                    this.waitInput('/root # ');
                    break;
                  case 'help':
                    this.print(
                      'help [command]    - Display help for a command<br />' +
                      'ls                - List files in current directory<br />' +
                      'cd [path]         - Change directory. Use \'..\' to go up a directory<br />' +
                      'poweroff          - Shut down the computer<br />' +
                      '<br />' +
                      'All binaries located in /bin can also be executed as commands.<br /><br />');
                    this.waitInput();
                    break;
                  case 'poweroff':
                    return this.switchState('init', { cls: true });
                  default:
                    this.print(`Unknown command: ${game.input}<br />For a list of commands, type 'help'.<br /><br />`);
                    this.waitInput();
                    break;
                }
                break;
            }
          }
        }

        render() {
          document.getElementById('terminal').innerHTML = game.terminalBuffer.join('') + game.prompt + game.input;
        }

        print(text) {
          this.terminalBuffer.push(text);
          this.render();
        }

        async switchState(state, options = { cls: false }) {
          this.state = state;
          this.input = '';

          if (options.cls) {
            document.getElementById('terminal').innerHTML = '';
            this.terminalBuffer = [];
          }

          return this.refresh();
        }

        waitInput(prompt) {
          this.input = '';

          if (prompt) {
            this.prompt = prompt;
          }
          this.render();

          this.terminalState = 'input';
        }
      }

      const game = new Game();

      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('fullscreen').addEventListener('click', async () => {
          const docElm = document.documentElement;
          if (docElm.requestFullscreen) {
            docElm.requestFullscreen();
          } else if (docElm.msRequestFullscreen) {
            docElm.msRequestFullscreen();
          } else if (docElm.mozRequestFullScreen) {
            docElm.mozRequestFullScreen();
          } else if (docElm.webkitRequestFullScreen) {
            docElm.webkitRequestFullScreen();
          }

          document.getElementById('terminal').innerHTML = '';
          await sleep(100);
          document.getElementById('terminal').innerHTML = 'Entering fullscreen mode...<br /><br />';
          await sleep(400);
          document.getElementById('terminal').classList.add('monospace');
          await sleep(1000);
          document.getElementById('terminal').classList.add('terminal12px');
          await sleep(1000);
          document.getElementById('terminal').classList.add('nocursor');
          await sleep(500);
          document.getElementById('terminal').innerHTML += 'No player data found. Starting new game.';
          await sleep(1500);
          document.getElementById('terminal').innerHTML = '';
          await sleep(1500);
          await game.init();
        });
      });
    </script>
  </head>
  <body id="terminal">
    <button id="fullscreen">Launch Game</button>
  </body>
</html>
